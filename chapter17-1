#include <Preferences.h>
#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 5
#define RST_PIN 27

MFRC522 rfid(SS_PIN, RST_PIN);
Preferences prefs;

void setup() {
  Serial.begin(115200);
  SPI.begin();
  rfid.PCD_Init();
  Serial.println("Ù…Ù†ØªØ¸Ø± Ú©Ø§Ø±Øª...");
}

void loop() {
  // Ø§Ú¯Ø± Ú©Ø§Ø±ØªÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯ØŒ Ø¨Ø±Ùˆ Ø¨ÛŒØ±ÙˆÙ†
  if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial())
    return;

  byte* uid = rfid.uid.uidByte;
  byte uidSize = rfid.uid.size;

  Serial.print("Ú©Ø§Ø±Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. UID: ");
  for (byte i = 0; i < uidSize; i++) {
    Serial.printf("%02X ", uid[i]);
  }
  Serial.println();

  // Ø°Ø®ÛŒØ±Ù‡ UID Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ (ÙÙ‚Ø· Ø§Ú¯Ø± Ø¨Ø§Ø± Ø§ÙˆÙ„ Ø¨Ø§Ø´Ø¯ ÛŒØ§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
  prefs.begin("cards", false);

  byte storedUID[4] = {0};
  prefs.getBytes("master_uid", storedUID, 4);

  bool isDifferent = false;
  for (int i = 0; i < 4; i++) {
    if (uid[i] != storedUID[i]) {
      isDifferent = true;
      break;
    }
  }

  if (isDifferent) {
    prefs.putBytes("master_uid", uid, 4);
    Serial.println("âœ… UID Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
  } else {
    Serial.println("ðŸŸ¢ Ø§ÛŒÙ† UID Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡");
  }

  prefs.end();

  delay(2000);  // ØªØ£Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ
  rfid.PICC_HaltA();
  rfid.PCD_StopCrypto1();
}


