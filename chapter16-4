#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 5    // SDA
#define RST_PIN 27  // RST

MFRC522 rfid(SS_PIN, RST_PIN); // Ø´ÛŒØ¡ Ø§Ø² Ú©Ù„Ø§Ø³ MFRC522

// Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†
struct Player {
  byte uid[4];     // UID Ú©Ø§Ø±Øª
  int balance;      // Ø§Ø¹ØªØ¨Ø§Ø±
};

// Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (Ø­Ø¯Ø§Ú©Ø«Ø± 8 Ú©Ø§Ø±Øª)
Player players[8];
int playerCount = 0;

void setup() {
  Serial.begin(115200);
  SPI.begin();
  rfid.PCD_Init();

  Serial.println("ğŸ® Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù† Ø¨Ø§Ø²ÛŒ Monopoly Ø³Ø§Ø¯Ù‡ â€” Ø´Ø±ÙˆØ¹ Ø´Ø¯");
  Serial.println("ğŸ“Œ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú©Ø§Ø±Øª Ø±Ø§ Ù†Ø²Ø¯ÛŒÚ© Ú©Ù†ÛŒØ¯...");
}

void loop() {
  if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial()) {
    return;
  }

  // ØªØ´Ø®ÛŒØµ Ú©Ø§Ø±Øª
  Serial.print("ğŸ“œ UID : ");
  for (byte i = 0; i < rfid.uid.size; i++) {
    Serial.print(rfid.uid.uidByte[i] < 0x10 ? " 0" : " ");
    Serial.print(rfid.uid.uidByte[i], HEX);
  }
  Serial.println();

  // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Øª Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŸ
  int index = findPlayerIndex(rfid.uid.uidByte);

  if (index == -1) {
    addNewPlayer(rfid.uid.uidByte);
    index = playerCount - 1;
    Serial.println("âœ… Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯ Ùˆ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ú¯Ø±Ø¯ÛŒØ¯.");
  } else {
    Serial.println("ğŸŸ¢ Ú©Ø§Ø±Øª Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡. Ø¨Ù‡ Ù…Ù†Ùˆ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯:");
    showMenu(index);
  }

  rfid.PICC_HaltA();
  rfid.PCD_StopCrypto1();
}

// ÛŒØ§ÙØªÙ† Ø´Ø§Ø®Øµ Ú©Ø§Ø±Øª Ø¯Ø± Ù„ÛŒØ³Øª
int findPlayerIndex(byte *uid) {
  for (int i = 0; i < playerCount; i++) {
    bool match = true;
    for (int j = 0; j < 4; j++) {
      if (players[i].uid[j] != uid[j]) {
        match = false;
        break;
      }
    }
    if (match) return i;
  }
  return -1;
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯
void addNewPlayer(byte *uid) {
  if (playerCount >= 8) {
    Serial.println("âš ï¸ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Øª (8 Ø¹Ø¯Ø¯) Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.");
    return;
  }

  for (int i = 0; i < 4; i++) {
    players[playerCount].uid[i] = uid[i];
  }
  players[playerCount].balance = 1500; // Ø§Ø¹ØªØ¨Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ø²ÛŒÚ©Ù†
  playerCount++;

  Serial.print("â• Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø± $");
  Serial.println(players[playerCount - 1].balance);
}

// Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ
void showMenu(int index) {
  Serial.println("ğŸ”¢ Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ØŸ");
  Serial.println("1. Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ");
  Serial.println("2. Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ");
  Serial.println("3. Ú©Ø§Ù‡Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ");

  while (true) {
    if (Serial.available()) {
      char choice = Serial.read();
      switch (choice) {
        case '1':
          Serial.print("ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§: $");
          Serial.println(players[index].balance);
          return;
        case '2':
          players[index].balance += 500;
          Serial.print("ğŸ’¸ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: $");
          Serial.println(players[index].balance);
          return;
        case '3':
          players[index].balance -= 500;
          if (players[index].balance < 0) players[index].balance = 0;
          Serial.print("ğŸ›’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: $");
          Serial.println(players[index].balance);
          return;
        default:
          Serial.println("âŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          break;
      }
    }
  }
}
