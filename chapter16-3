#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 5
#define RST_PIN 27
#define LED_PIN 2

MFRC522 rfid(SS_PIN, RST_PIN);

// ØªØ¹Ø±ÛŒÙ Ú©Ø§Ø±Øª Ù…Ø¯ÛŒØ±ÛŒØª
byte masterUID[4] = {0x62, 0xFE, 0x17, 0x51};

// Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø² (Ø­Ø¯Ø§Ú©Ø«Ø± 10 Ú©Ø§Ø±Øª)
byte allowedCards[10][4];
int allowedCount = 0;

void setup() {
  Serial.begin(115200);
  SPI.begin();
  rfid.PCD_Init();

  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  Serial.println(â€œSystem ready. Waiting for a card...â€);
}

void loop() {
  if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial()) {
    return;
  }

  // Ù†Ù…Ø§ÛŒØ´ UID Ú©Ø§Ø±Øª
  Serial.print(â€œCard UID: â€œ);
  for (byte I = 0; I < rfid.uid.size; i++) {
    Serial.print(rfid.uid.uidByte[i] < 0x10 ? â€œ 0â€ : â€œ â€œ);
    Serial.print(rfid.uid.uidByte[i], HEX);
  }
  Serial.println();

  if (isMasterCard(rfid.uid.uidByte)) {
    Serial.println(â€œğŸ”‘ Master card detected. Entering registration mode for 5 seconds...â€);
    registerNewCards();
  } else if (isAllowedCard(rfid.uid.uidByte)) {
    Serial.println(â€œâœ… Access granted. Welcome!â€);
    digitalWrite(LED_PIN, HIGH);
    delay(3000);
    digitalWrite(LED_PIN, LOW);
  } else {
    Serial.println(â€œâ›” Access denied.â€);
  }

  rfid.PICC_HaltA();
  rfid.PCD_StopCrypto1();
}

///////  ØªØ§Ø¨Ø¹   Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Øª Ù…Ø¯ÛŒØ±ÛŒØª
bool isMasterCard(byte *uid) {
  for (int I = 0; I < 4; i++) {
    if (uid[i] != masterUID[i]) return false;
  }
  return true;
}

/// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Øª Ù…Ø¬Ø§Ø²
bool isAllowedCard(byte *uid) {
  for (int I = 0; I < allowedCount; i++) {
    bool match = true;
    for (int j = 0; j < 4; j++) {
      if (uid[j] != allowedCards[i][j]) {
        match = false;
        break;
      }
    }
    if (match) return true;
  }
  return false;
}

// Ø«Ø¨Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
void registerNewCards() {
  unsigned long startTime = millis();
  while (millis() â€“ startTime < 5000) {
    if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial()) {
      continue;
    }

    if (!isAllowedCard(rfid.uid.uidByte)) {
      if (allowedCount < 10) {
        for (int I = 0; I < 4; i++) {
          allowedCards[allowedCount][i] = rfid.uid.uidByte[i];
        }
        allowedCount++;
        Serial.println(â€œâœ… New card registered.â€);
      } else {
        Serial.println(â€œâš ï¸ Card list is full.â€);
      }
    } else {
      Serial.println(â€œâ„¹ï¸ Card already registered.â€);
    }

    rfid.PICC_HaltA();
    rfid.PCD_StopCrypto1();
    delay(500);
  }
  Serial.println(â€œâ± Registration mode ended.â€);
}
